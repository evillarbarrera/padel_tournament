<%= form_with(model: @campeonato, local: true, html: { multipart: true }) do |form| %>
  <ul class="nav nav-tabs mb-4" id="campeonatoTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <a class="nav-link active" id="datos-tab" data-bs-toggle="tab" href="#datos" role="tab" aria-controls="datos" aria-selected="true">Datos B√°sicos</a>
    </li>
    <li class="nav-item" role="presentation">
      <a class="nav-link" id="tipos-tab" data-bs-toggle="tab" href="#tipos" role="tab" aria-controls="tipos" aria-selected="false">Tipos Inscripci√≥n</a>
    </li>
    <li class="nav-item" role="presentation">
      <a class="nav-link" id="categorias-tab" data-bs-toggle="tab" href="#categorias" role="tab" aria-controls="categorias" aria-selected="false">Categor√≠as</a>
    </li>
       <li class="nav-item" role="presentation">
      <a class="nav-link" id="inscripciones-tab" data-bs-toggle="tab" href="#inscripciones" role="tab" aria-controls="inscripciones" aria-selected="false">Inscripciones</a>
    </li>
    <li class="nav-item" role="presentation">
      <a class="nav-link" id="partidos-tab" data-bs-toggle="tab" href="#partidos" role="tab" aria-controls="partidos" aria-selected="false">Partidos</a>
    </li>
  </ul>

  <div class="tab-content" id="campeonatoTabsContent">
    <!-- Datos B√°sicos -->
    <div class="tab-pane fade show active" id="datos" role="tabpanel" aria-labelledby="datos-tab">
      <div class="row">
        <div class="mb-3 col-12">
          <label>Club</label>
          <input type="text" class="form-control" value="<%= current_user.club.nombre %>" disabled>
        </div>

        <div class="col-md-6 mb-3">
          <%= form.label :nombre %>
          <%= form.text_field :nombre, class: "form-control" %>
        </div>

        <div class="col-md-2">
          <%= form.label :tipo, "Tipo de Campeonato" %>
          <%= form.select :tipo, ['Campeonato', 'Liga', 'Americano'], {}, class: "form-control" %>
        </div>

        <div class="col-md-2">
          <%= form.label :fecha_inicio %>
          <%= form.date_field :fecha_inicio, class: "form-control" %>
        </div>

        <div class="col-md-2">
          <%= form.label :fecha_termino %>
          <%= form.date_field :fecha_termino, class: "form-control" %>
        </div>

        <div class="col-md-2">
          <%= form.label :cupos_maximos, "Cupos M√°ximos" %>
          <%= form.number_field :cupos_maximos, class: "form-control" %>
        </div>

        <div class="col-md-2">
          <%= form.label :estado %>
          <%= form.select :estado, ['Pendiente', 'Abierto', 'En curso', 'Finalizado'], {}, class: "form-control" %>
        </div>
      </div>

      <div class="mb-3">
        <%= form.label :descripcion %>
        <%= form.text_area :descripcion, class: "form-control", rows: 3 %>
      </div>

      <div class="mb-3">
        <%= form.label :normativo, "Normativa" %>
        <%= form.text_area :normativo, class: "form-control", rows: 3 %>
      </div>

      <div class="mb-3">
        <%= form.label :reglas, "Reglas adicionales" %>
        <%= form.text_area :reglas, class: "form-control", rows: 3 %>
      </div>

      <div class="mb-3">
        <%= form.label :foto %>
        <%= form.file_field :foto, class: "form-control form-control-sm input-compact", style: "border-radius: 8px; height: 34px; width: 100%;" %>
      </div>
    </div>

    <!-- Tipos Inscripci√≥n -->
    <div class="tab-pane fade" id="tipos" role="tabpanel" aria-labelledby="tipos-tab">
      <div id="tipos-inscripcion-container">
        <% if @campeonato.tipo_inscripcions.any? %>
          <% @campeonato.tipo_inscripcions.each_with_index do |tipo, index| %>
            <div class="mb-3 border p-3 rounded tipo-inscripcion">
              <h6>Tipo de Inscripci√≥n <%= index + 1 %></h6>
              <button type="button" class="btn btn-sm btn-danger float-end eliminar-tipo">Eliminar</button>

              <!-- Campo oculto con el ID -->
              <input type="hidden" name="tipo_id[]" value="<%= tipo.id %>">

              <div class="mb-2">
                <label>Nombre</label>
                <input type="text" class="form-control" name="tipo_nombre[]" value="<%= tipo.nombre %>">
              </div>
              <div class="mb-2">
                <label>Monto</label>
                <input type="number" class="form-control" name="tipo_monto[]" value="<%= tipo.monto %>">
              </div>
              <div class="mb-2">
                <label>Fecha l√≠mite de pago</label>
                <input type="date" class="form-control" name="tipo_fecha_limite[]" value="<%= tipo.fecha_limite_pago %>">
              </div>
              <div class="mb-2">
                <label>Beneficios</label>
                <textarea class="form-control" name="tipo_beneficios[]"><%= tipo.beneficios %></textarea>
              </div>
            </div>
          <% end %>
        <% else %>
          <div class="mb-3 border p-3 rounded tipo-inscripcion">
            <h6>Tipo de Inscripci√≥n 1</h6>
            <button type="button" class="btn btn-sm btn-danger float-end eliminar-tipo">Eliminar</button>
            <div class="mb-2">
              <label>Nombre</label>
              <input type="text" class="form-control" name="tipo_nombre[]">
            </div>
            <div class="mb-2">
              <label>Monto</label>
              <input type="number" class="form-control" name="tipo_monto[]">
            </div>
            <div class="mb-2">
              <label>Fecha l√≠mite de pago</label>
              <input type="date" class="form-control" name="tipo_fecha_limite[]">
            </div>
            <div class="mb-2">
              <label>Beneficios</label>
              <textarea class="form-control" name="tipo_beneficios[]"></textarea>
            </div>
          </div>
        <% end %>
      </div>
      <button type="button" class="btn btn-outline-primary mt-2" id="agregar-tipo">+ Agregar tipo</button>
    </div>


    <!-- Categor√≠as -->
    <div class="tab-pane fade" id="categorias" role="tabpanel" aria-labelledby="categorias-tab">
        <h5 class="mb-3">Selecciona las categor√≠as del campeonato</h5>
        <div class="mb-4 d-flex flex-wrap gap-2">
          <button type="button" class="btn btn-sm btn-primary mb-2" onclick="toggleCheckboxes('all', true)">Seleccionar todos</button>
            <button type="button" class="btn btn-sm btn-secondary mb-2" onclick="toggleCheckboxes('hombres', true)">Seleccionar todos hombres</button>
            <button type="button" class="btn btn-sm btn-secondary mb-2" onclick="toggleCheckboxes('mujeres', true)">Seleccionar todos mujeres</button>
            <button type="button" class="btn btn-sm btn-danger mb-2" onclick="toggleCheckboxes('all', false)">Deseleccionar todos</button>

        </div>

       
        
        <div class="row">
          <!-- Categor√≠as Mujeres a la izquierda -->
          <div class="col-md-6">
            <h4>Categor√≠as Mujeres</h4>
            <button type="button" class="btn btn-sm btn-primary mb-2" onclick="toggleCheckboxes('mujeres', true)">Seleccionar todo</button>
            <button type="button" class="btn btn-sm btn-secondary mb-2" onclick="toggleCheckboxes('mujeres', false)">Deseleccionar todo</button>

            <% @categorias.where(sexo: 'Mujeres').each do |categoria| %>
              <div class="form-check">
                <%= check_box_tag "campeonato[categoria_ids][]", categoria.id, @campeonato.categoria_ids.include?(categoria.id), id: "categoria_#{categoria.id}", class: "form-check-input mujeres" %>
                <%= label_tag "categoria_#{categoria.id}", categoria.nombre, class: "form-check-label" %>
              </div>
            <% end %>
          </div>

          <!-- Categor√≠as Hombres a la derecha -->
          <div class="col-md-6">
            <h4>Categor√≠as Hombres</h4>
            <button type="button" class="btn btn-sm btn-primary mb-2" onclick="toggleCheckboxes('hombres', true)">Seleccionar todo</button>
            <button type="button" class="btn btn-sm btn-secondary mb-2" onclick="toggleCheckboxes('hombres', false)">Deseleccionar todo</button>

            <% @categorias.where(sexo: 'Hombres').each do |categoria| %>
              <div class="form-check">
                <%= check_box_tag "campeonato[categoria_ids][]", categoria.id, @campeonato.categoria_ids.include?(categoria.id), id: "categoria_#{categoria.id}", class: "form-check-input hombres" %>
                <%= label_tag "categoria_#{categoria.id}", categoria.nombre, class: "form-check-label" %>
              </div>
            <% end %>
          </div>
        </div>
    </div>

    <!-- Inscripciones -->
    <div class="tab-pane fade" id="inscripciones" role="tabpanel" aria-labelledby="inscripciones-tab">
          <% if @campeonato.inscripciones.any? %>
            <table class="table">
              <thead>
                <tr>
                  <th>Jugador</th>
                  <th>Categor√≠a</th>
                </tr>
              </thead>
              <tbody>
                <% @campeonato.inscripciones.each do |inscripcion| %>
                  <tr>
                    <td><%= inscripcion.user.nombre %></td>
                    <td><%= inscripcion.categoria.nombre %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          <% else %>
            <p>No hay inscripciones registradas.</p>
          <% end %>
        </div>
    </div>
    
    <!-- Partidos -->
   <!-- Partidos -->
    <div class="tab-pane fade" id="partidos" role="tabpanel" aria-labelledby="partidos-tab">
      <ul class="nav nav-tabs mt-3" id="partidosSubTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="horarios-tab" data-bs-toggle="tab" data-bs-target="#horarios" type="button" role="tab" aria-controls="horarios" aria-selected="true">
            Horarios Bloqueados
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="calendario-tab" data-bs-toggle="tab" data-bs-target="#calendario" type="button" role="tab" aria-controls="calendario" aria-selected="false">
            Generaci√≥n de Calendario
          </button>
        </li>
      </ul>

      <div class="tab-content pt-3" id="partidosSubTabsContent">
        <div class="tab-pane fade show active" id="horarios" role="tabpanel" aria-labelledby="horarios-tab">
          <!-- Aqu√≠ va el contenido de Horarios Bloqueados -->
          <div>
              <div>
                <h5>Selecciona los horarios bloqueados</h5>
                <div class="alert alert-info">
                  El calendario se genera din√°micamente seg√∫n la <strong>fecha de inicio</strong> y <strong>fecha de t√©rmino</strong> del campeonato.
                </div>

                <div class="row mb-3">
                  <div class="col-md-3">
                    <%= form.label :fecha_inicio, "Fecha de Inicio" %>
                    <%= form.date_field :fecha_inicio, class: "form-control", id: "fecha_inicio_bloqueo" %>
                  </div>
                  <div class="col-md-3">
                    <%= form.label :fecha_termino, "Fecha de T√©rmino" %>
                    <%= form.date_field :fecha_termino, class: "form-control", id: "fecha_termino_bloqueo" %>
                  </div>
                </div>

                <div id="bloqueador-calendario" class="table-responsive">
                  <table class="table table-bordered text-center">
                    <thead>
                      <tr>
                        <th>Hora</th>
                        <th>Lunes</th>
                        <th>Martes</th>
                        <th>Mi√©rcoles</th>
                        <th>Jueves</th>
                        <th>Viernes</th>
                        <th>S√°bado</th>
                        <th>Domingo</th>
                      </tr>
                    </thead>
                    <tbody id="bloqueador-body">
                      <!-- Se rellena con JS -->
                    </tbody>
                  </table>
                </div>

                <button type="button" class="btn btn-primary mt-3" id="guardar-bloqueos">Guardar Horarios Bloqueados</button>
              </div>
        </div>
        <div class="tab-pane fade" id="calendario" role="tabpanel" aria-labelledby="calendario-tab">
          <!-- Aqu√≠ va el contenido de Generaci√≥n de Calendario -->
          <p>Contenido para generaci√≥n de calendario...</p>
        </div>
      </div>
    </div>
                

  </div>

  <div class="mt-4">
    <%= form.submit "Guardar Campeonato", class: "btn btn-primary" %>
  </div>
<% end %>
<script>
  // Agregar nuevo tipo inscripci√≥n
  document.getElementById('agregar-tipo').addEventListener('click', function() {
    const container = document.getElementById('tipos-inscripcion-container');
    const count = container.querySelectorAll('.tipo-inscripcion').length + 1;

    const div = document.createElement('div');
    div.classList.add('mb-3', 'border', 'p-3', 'rounded', 'tipo-inscripcion');

    div.innerHTML = `
      <h6>Tipo de Inscripci√≥n ${count}</h6>
      <button type="button" class="btn btn-sm btn-danger float-end eliminar-tipo">Eliminar</button>
      <div class="mb-2">
        <label>Nombre</label>
        <input type="text" class="form-control" name="tipo_nombre[]">
      </div>
      <div class="mb-2">
        <label>Monto</label>
        <input type="number" class="form-control" name="tipo_monto[]">
      </div>
      <div class="mb-2">
        <label>Fecha l√≠mite de pago</label>
        <input type="date" class="form-control" name="tipo_fecha_limite[]">
      </div>
      <div class="mb-2">
        <label>Beneficios</label>
        <textarea class="form-control" name="tipo_beneficios[]"></textarea>
      </div>
    `;

    container.appendChild(div);
  });

  // Eliminar tipo inscripci√≥n
  document.getElementById('tipos-inscripcion-container').addEventListener('click', function(event) {
    if(event.target.classList.contains('eliminar-tipo')) {
      const tipoDiv = event.target.closest('.tipo-inscripcion');
      tipoDiv.remove();
      // Re-numerar t√≠tulos
      const tipos = document.querySelectorAll('.tipo-inscripcion h6');
      tipos.forEach((h6, index) => {
        h6.textContent = `Tipo de Inscripci√≥n ${index + 1}`;
      });
    }
  });
</script>



<script>
  // Funci√≥n para seleccionar/deseleccionar checkboxes seg√∫n grupo
  function toggleCheckboxes(group, select) {
    let checkboxes;
    if (group === 'all') {
      checkboxes = document.querySelectorAll('.form-check-input');
    } else if (group === 'hombres') {
      checkboxes = document.querySelectorAll('.form-check-input.hombres');
    } else if (group === 'mujeres') {
      checkboxes = document.querySelectorAll('.form-check-input.mujeres');
    }

    checkboxes.forEach(cb => cb.checked = select);
  }
</script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    console.log("‚úÖ DOM completamente cargado");

    const dias = ["Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado", "Domingo"];
    const bloqueadorBody = document.getElementById("bloqueador-body");
    const campeonatoId = <%= @campeonato.id %>; // Debe estar presente en tu template

    // Construcci√≥n de la tabla - filas desde las 08 hasta las 22 horas
    for (let h = 8; h <= 22; h++) {
      const row = document.createElement("tr");

      const hora = document.createElement("td");
      hora.textContent = `${h.toString().padStart(2, "0")}:00`;
      row.appendChild(hora);

      dias.forEach(dia => {
        const cell = document.createElement("td");
        cell.dataset.hora = h;
        cell.dataset.dia = dia;
        cell.style.cursor = "pointer";
        cell.classList.add("bloque-horario");

        cell.addEventListener("click", function () {
          this.classList.toggle("table-primary");
        });

        row.appendChild(cell);
      });

      bloqueadorBody.appendChild(row);
    }

    // Cargar bloqueos guardados
    const urlBloqueos = `/campeonatos/${campeonatoId}/bloqueos`;
    console.log("üîÑ Cargando bloqueos desde:", urlBloqueos);

    fetch(urlBloqueos)
      .then(res => {
        if (!res.ok) {
          throw new Error(`‚ùå Error al cargar bloqueos (${res.status})`);
        }
        return res.json();
      })
      .then(data => {
        console.log("üì¶ Bloqueos recibidos:", data);

        // D√≠as en JS: Domingo = 0, Lunes = 1, ...
        const diasJS = ["Domingo", "Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado"];

        data.forEach(bloqueo => {
          if (!bloqueo.fechahora_inicio) {
            console.warn("Bloqueo sin fecha de inicio:", bloqueo);
            return;
          }

          const fecha = new Date(bloqueo.fechahora_inicio);
          const dia = diasJS[fecha.getDay()]; // nombre d√≠a local
          const hora = fecha.getHours();      // hora local

          console.log(`Procesando bloqueo: D√≠a local: ${dia}, Hora local: ${hora}`);

          if (!dias.includes(dia)) {
            console.warn(`D√≠a no reconocido en tabla: ${dia}`);
            return;
          }

          // Solo marcar si la hora est√° en el rango visible
          if (hora < 8 || hora > 22) {
            console.log(`Bloqueo fuera del rango visible: ${dia} ${hora}`);
            return;
          }

          const selector = `.bloque-horario[data-dia="${dia}"][data-hora="${hora}"]`;
          const cell = document.querySelector(selector);

          if (cell) {
            cell.classList.add("table-primary");
          } else {
            console.warn(`No se encontr√≥ celda para ${dia} ${hora}`);
          }
        });
      })
      .catch(error => {
        console.error("‚ùå Error en fetch de bloqueos:", error);
      });

    // Guardar bloqueos
    document.getElementById("guardar-bloqueos").addEventListener("click", () => {
      const fecha_inicio = document.getElementById("fecha_inicio_bloqueo").value;
      const fecha_termino = document.getElementById("fecha_termino_bloqueo").value;

      const seleccionados = Array.from(document.querySelectorAll(".bloque-horario.table-primary"))
        .map(cell => ({
          dia: cell.dataset.dia,
          hora: cell.dataset.hora
        }));

      console.log("üì§ Enviando bloqueos:", seleccionados);
      console.log("üìÖ Fecha inicio:", fecha_inicio);
      console.log("üìÖ Fecha t√©rmino:", fecha_termino);

      const urlGuardar = `/campeonatos/${campeonatoId}/guardar_bloqueos`;
      console.log("üì® URL POST:", urlGuardar);

      fetch(urlGuardar, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRF-Token": document.querySelector("[name='csrf-token']").content
        },
        body: JSON.stringify({
          bloqueos: seleccionados,
          fecha_inicio,
          fecha_termino
        })
      })
        .then(res => {
          console.log("üîΩ Respuesta POST status:", res.status);
          if (!res.ok) {
            throw new Error(`‚ùå Error al guardar bloqueos (${res.status})`);
          }
          return res.json();
        })
        .then(data => {
          console.log("‚úÖ Bloqueos guardados correctamente:", data);
          alert("Bloqueos guardados con √©xito.");
        })
        .catch(error => {
          console.error("‚ùå Error al guardar bloqueos:", error);
          alert("Error al guardar bloqueos.");
        });
    });
  });
</script>
